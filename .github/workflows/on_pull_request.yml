name: Process Audio - Pull Request (Beta)

on:
  pull_request:
    branches:
      - main
    paths:
      - 'audio_inputs/**'
      - 'process_audio.py'
      - '.github/workflows/on_pull_request.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  process-audio-beta:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Process audio files (Beta)
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          TARGET_LANGUAGE: ${{ secrets.TARGET_LANGUAGE }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ENVIRONMENT: beta
        run: |
          python scripts/process_audio.py
      
      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `
            ## ${emoji} Audio Processing - Beta Environment
            
            **Status**: ${status.toUpperCase()}
            **Environment**: \`beta\`
            **Target Language**: \`${{ secrets.TARGET_LANGUAGE }}\`
            **S3 Bucket**: \`${{ secrets.S3_BUCKET }}\`
            
            ### Processed Files
            All outputs have been uploaded to the \`beta/\` prefix in S3:
            - üìù Transcripts: \`s3://${{ secrets.S3_BUCKET }}/beta/transcripts/\`
            - üåç Translations: \`s3://${{ secrets.S3_BUCKET }}/beta/translations/\`
            - üîä Audio Outputs: \`s3://${{ secrets.S3_BUCKET }}/beta/audio_outputs/\`
            
            ${status === 'success' ? '‚ú® Ready for review! Merge this PR to deploy to production.' : '‚ö†Ô∏è Processing failed. Please check the workflow logs for details.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });